name: CI/CD Pipeline (Build -> Deploy)

on:
  push:
    tags:
      - 'v*' # Chạy khi đánh tag

permissions:
  contents: read
  packages: write # Cần quyền write để push ảnh, read để pull ảnh

jobs:
  # --- GIAI ĐOẠN 1: BUILD & PUSH (Chạy trên Github Cloud) ---
  build-and-push:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Gateway
      - name: Build & Push Gateway
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$OWNER_LC/landslide-gateway
          TAG=${{ steps.get_version.outputs.VERSION }}
          
          cd gateway
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

      # Build Server
      - name: Build & Push Server
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$OWNER_LC/landslide-server
          TAG=${{ steps.get_version.outputs.VERSION }}
          
          cd server
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

  # --- GIAI ĐOẠN 2: DEPLOY (Chạy trên Server thật) ---
  deploy:
    name: Deploy to Server
    needs: build-and-push # <--- CHÌA KHÓA Ở ĐÂY: Phải chờ thằng trên xong mới được chạy
    runs-on: self-hosted
    steps:
      # Pre-cleanup: FORCE DELETE workspace to avoid permission issues
      - name: Pre-cleanup - Remove Workspace
        run: |
          echo "=== Pre-cleanup: Force removing workspace ==="
          WORKSPACE_PATH="${GITHUB_WORKSPACE:-$HOME/actions-runner/_work/landslide-monitoring/landslide-monitoring}"
          echo "Workspace path: $WORKSPACE_PATH"
          echo "Current user: $USER"
          
          # Kiểm tra xem thư mục có tồn tại không
          if [ -d "$WORKSPACE_PATH" ]; then
            echo "Workspace exists, FORCE deleting entire workspace with sudo..."
            # XÓA TOÀN BỘ workspace bằng sudo để tránh mọi vấn đề permission
            sudo rm -rf "$WORKSPACE_PATH" || echo "Warning: rm -rf failed"
            
            # Tạo lại thư mục trống với owner đúng
            mkdir -p "$WORKSPACE_PATH" || true
            sudo chown -R $USER:$USER "$WORKSPACE_PATH" || true
            
            echo "Workspace cleaned successfully"
          else
            echo "Workspace does not exist yet, creating..."
            mkdir -p "$WORKSPACE_PATH" || true
            sudo chown -R $USER:$USER "$WORKSPACE_PATH" || true
          fi
          
          echo "Pre-cleanup completed"
        continue-on-error: true
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false  # Tắt clean vì pre-cleanup đã xử lý

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy Steps
        run: |
          echo "Starting deploy version ${{ steps.get_version.outputs.VERSION }}..."
          
          # --- FIX PERMISSIONS (VẤN ĐỀ 1) ---
          # Lấy lại quyền sở hữu thư mục hiện tại để tránh lỗi permission denied khi checkout/clean
          echo "Fixing permissions..."
          sudo chown -R $USER:$USER . || echo "Warning: Could not chown, trying to proceed..."
          
          # --- 1. SERVER APP ---
          cd server
          export APP_VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Đặt tên project cố định để tránh tạo ra các container mồ côi
          export COMPOSE_PROJECT_NAME=landslide_server

          # --- DỌN DẸP CONTAINER CŨ (VẤN ĐỀ 2) ---
          echo "Cleaning up old containers..."
          # Down toàn bộ service cũ để tránh conflict tên
          docker-compose down --remove-orphans || true
          
          # Tải image mới nhất
          docker-compose pull
          
          # Up container
          echo "Starting services..."
          docker-compose up -d --force-recreate
          
          # Kiểm tra ngay lập tức xem container có chạy không
          echo "Checking container status:"
          docker-compose ps
          
          # Restart Spark
          echo "Restarting Spark..."
          docker restart spark-master
          sleep 10
          
          # Submit Spark job và ghi log vào file trong container
          echo "Submitting Spark job with logging..."
          docker exec spark-master bash -c "nohup /opt/spark/bin/spark-submit \
            --master spark://spark-master:7077 \
            --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0 \
            /app/spark_jobs/processor.py > /tmp/spark_job.log 2>&1 &"
          
          # Đợi job khởi động và xử lý dữ liệu (tăng lên 60s để có ít nhất 1 batch)
          echo "Waiting 60s for Spark job to process data..."
          sleep 60
          
          # Lưu bảng dữ liệu ASCII từ Spark vào file
          # Lưu vào thư mục cố định trong home directory để dễ truy cập
          LOG_DIR="$HOME/spark_logs"
          mkdir -p "$LOG_DIR"
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          LOG_FILE="$LOG_DIR/spark_data_${TIMESTAMP}.log"
          
          echo "Saving Spark processing data to file: $LOG_FILE"
          
          {
            echo "=========================================="
            echo "Spark Processing Data (ASCII Table)"
            echo "Timestamp: $(date)"
            echo "Version: ${{ steps.get_version.outputs.VERSION }}"
            echo "=========================================="
            echo ""
            
            echo "--- Spark Job Output (from /tmp/spark_job.log) ---"
            # Đọc log trực tiếp từ file mà Spark job đang ghi
            docker exec spark-master cat /tmp/spark_job.log 2>/dev/null || echo "Job log file not found yet"
            echo ""
            
            echo "--- Recent Spark Master Logs (last 200 lines) ---"
            docker logs spark-master --tail 200 2>&1
            echo ""
            
            echo "--- Recent Spark Worker Logs (last 200 lines) ---"
            docker logs spark-worker --tail 200 2>&1 || echo "Worker logs not available"
            echo ""
            
            echo "=========================================="
            echo "End of log"
            echo "=========================================="
          } > "$LOG_FILE"
          
          # Kiểm tra file đã được tạo chưa
          if [ -f "$LOG_FILE" ]; then
            echo "✓ Spark data saved to: $LOG_FILE"
            echo "✓ File size: $(du -h "$LOG_FILE" | cut -f1)"
            echo "✓ Full path: $(realpath "$LOG_FILE")"
            ls -lh "$LOG_FILE"
          else
            echo "✗ ERROR: File was not created at $LOG_FILE"
            echo "Current directory: $(pwd)"
            echo "Log directory exists: $([ -d "$LOG_DIR" ] && echo 'Yes' || echo 'No')"
          fi
            
          # --- 2. GATEWAY (Nếu chạy chung server) ---
          echo "Deploying Gateway..."
          cd ../gateway
          
          # Đặt tên project cho gateway
          export COMPOSE_PROJECT_NAME=landslide_gateway
          
          # Dọn dẹp gateway cũ
          docker-compose down --remove-orphans || true
          
          # Pull và Up lại
          docker-compose pull
          docker-compose up -d --force-recreate
          
          echo "Checking Gateway status:"
          docker-compose ps

          echo "All Systems Deployed Successfully!"

