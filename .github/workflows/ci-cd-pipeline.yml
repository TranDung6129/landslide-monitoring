name: CI/CD Pipeline (Build -> Deploy)

on:
  push:
    tags:
      - 'v*' # Chạy khi đánh tag

permissions:
  contents: read
  packages: write # Cần quyền write để push ảnh, read để pull ảnh

jobs:
  # --- GIAI ĐOẠN 1: BUILD & PUSH (Chạy trên Github Cloud) ---
  build-and-push:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Gateway
      - name: Build & Push Gateway
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$OWNER_LC/landslide-gateway
          TAG=${{ steps.get_version.outputs.VERSION }}
          
          cd gateway
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

      # Build Server
      - name: Build & Push Server
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$OWNER_LC/landslide-server
          TAG=${{ steps.get_version.outputs.VERSION }}
          
          cd server
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

  # --- GIAI ĐOẠN 2: DEPLOY (Chạy trên Server thật) ---
  deploy:
    name: Deploy to Server
    needs: build-and-push # <--- CHÌA KHÓA Ở ĐÂY: Phải chờ thằng trên xong mới được chạy
    runs-on: self-hosted
    steps:
      - name: Clean Workspace (Fix Permission Issues)
        run: |
          echo "Cleaning workspace to fix permission issues..."
          WORKSPACE_DIR="${GITHUB_WORKSPACE:-$HOME/actions-runner/_work/landslide-monitoring/landslide-monitoring}"
          
          if [ -d "$WORKSPACE_DIR" ]; then
            echo "Workspace exists at: $WORKSPACE_DIR"
            echo "Removing files created by Docker containers (may require sudo)..."
            
            # Xóa các file log và data được tạo bởi containers
            sudo rm -rf "$WORKSPACE_DIR/gateway/mosquitto/log" 2>/dev/null || true
            sudo rm -rf "$WORKSPACE_DIR/gateway/mosquitto/data" 2>/dev/null || true
            sudo rm -rf "$WORKSPACE_DIR/server/spark/checkpoint" 2>/dev/null || true
            sudo rm -rf "$WORKSPACE_DIR/server/kafka/data" 2>/dev/null || true
            sudo rm -rf "$WORKSPACE_DIR/server/zookeeper/data" 2>/dev/null || true
            
            # Thay đổi ownership của toàn bộ workspace về user hiện tại
            echo "Changing ownership to current user..."
            sudo chown -R $(whoami):$(whoami) "$WORKSPACE_DIR" 2>/dev/null || true
            
            echo "Workspace cleanup completed!"
          else
            echo "Workspace does not exist yet, skipping cleanup."
          fi
      
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy Steps
        run: |
          echo "Starting deploy version ${{ steps.get_version.outputs.VERSION }}..."
          
          # --- BƯỚC 1: DỌN DẸP TẤT CẢ CONTAINER CŨ ---
          echo "=========================================="
          echo "STEP 1: Cleaning up old containers..."
          echo "=========================================="
          
          # Xóa tất cả container liên quan để tránh conflict
          # Danh sách container cần xóa (dựa trên log thủ công của bạn)
          CONTAINERS_TO_REMOVE="mosquitto mqtt-bridge kafka spark-master spark-worker zookeeper"
          
          for container in $CONTAINERS_TO_REMOVE; do
            if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
              echo "Removing container: $container"
              docker rm -f "$container" 2>/dev/null || echo "  → Already removed or not found"
            else
              echo "Container $container does not exist, skipping..."
            fi
          done
          
          # Xóa cả network cũ nếu có
          docker network rm landslide_network 2>/dev/null || echo "Network already removed or not found"
          
          echo ""
          echo "✓ Cleanup completed!"
          echo ""
          
          # --- BƯỚC 2: DEPLOY SERVER (TẠO TẤT CẢ CONTAINERS) ---
          echo "=========================================="
          echo "STEP 2: Deploying Server Stack..."
          echo "=========================================="
          
          cd server
          export APP_VERSION=${{ steps.get_version.outputs.VERSION }}
          export COMPOSE_PROJECT_NAME=landslide_server

          # Tải image mới nhất về
          echo "Pulling latest images..."
          docker-compose pull
          
          # Up tất cả containers (mosquitto, kafka, spark, zookeeper, mqtt-bridge)
          echo "Starting all containers with docker-compose..."
          docker-compose up -d
          
          # Đợi containers khởi động ổn định
          echo "Waiting for containers to be ready..."
          sleep 15
          
          # Kiểm tra trạng thái containers
          echo ""
          echo "Current running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          
          # --- BƯỚC 3: CHẠY SPARK JOB ---
          echo "=========================================="
          echo "STEP 3: Starting Spark Job..."
          echo "=========================================="
          
          # Chờ Spark Master sẵn sàng
          echo "Waiting for Spark Master to be ready..."
          for i in {1..30}; do
            if docker exec spark-master curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "✓ Spark Master is ready!"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 2
          done
          
          # Chạy Spark job trong background
          echo "Submitting Spark job..."
          docker exec -d spark-master /opt/spark/bin/spark-submit \
            --master spark://spark-master:7077 \
            --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0 \
            /app/spark_jobs/processor.py
          
          echo "✓ Spark job submitted successfully!"
          echo ""
          
          # --- BƯỚC 4: ĐỢI VÀ THU THẬP LOG ---
          echo "=========================================="
          echo "STEP 4: Collecting Spark Processing Logs..."
          echo "=========================================="
          
          # Đợi để Spark job xử lý dữ liệu (theo log bạn, cần ít nhất vài batch)
          echo "Waiting 40 seconds for Spark to process data batches..."
          sleep 40
          
          # Tạo thư mục log
          LOG_DIR="$HOME/spark_logs"
          mkdir -p "$LOG_DIR"
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          LOG_FILE="$LOG_DIR/spark_deployment_${TIMESTAMP}.log"
          
          echo "Saving Spark processing logs to: $LOG_FILE"
          
          {
            echo "=========================================="
            echo "LANDSLIDE MONITORING - SPARK DEPLOYMENT LOG"
            echo "=========================================="
            echo "Timestamp: $(date)"
            echo "Version: ${{ steps.get_version.outputs.VERSION }}"
            echo "Deployed by: CI/CD Pipeline"
            echo "=========================================="
            echo ""
            
            echo "CONTAINER STATUS:"
            echo "---"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(mosquitto|mqtt-bridge|kafka|zookeeper|spark)" || echo "No containers found"
            echo ""
            
            echo "=========================================="
            echo "SPARK MASTER LOGS (Last 800 lines)"
            echo "=========================================="
            docker logs spark-master --tail 800 2>&1
            echo ""
            
            echo "=========================================="
            echo "SPARK WORKER LOGS (Last 500 lines)"
            echo "=========================================="
            docker logs spark-worker --tail 500 2>&1 || echo "Worker logs not available"
            echo ""
            
            echo "=========================================="
            echo "MQTT BRIDGE LOGS (Last 300 lines)"
            echo "=========================================="
            docker logs mqtt-bridge --tail 300 2>&1 || echo "MQTT Bridge logs not available"
            echo ""
            
            echo "=========================================="
            echo "EXTRACTED BATCH PROCESSING DATA"
            echo "=========================================="
            echo "Looking for Batch processing tables..."
            echo ""
            
            # Thu thập tất cả logs từ Spark containers
            ALL_SPARK_LOGS=$(docker logs spark-master --tail 1500 2>&1)
            
            # Tìm và trích xuất bảng dữ liệu batch
            echo "$ALL_SPARK_LOGS" | grep -B 2 -A 8 "Batch:" | head -200 || echo "⚠️ No batch data found yet. Job may still be starting."
            
            echo ""
            echo "=========================================="
            echo "KAFKA TOPICS CHECK"
            echo "=========================================="
            docker exec kafka kafka-topics --list --bootstrap-server localhost:9092 2>&1 || echo "Cannot list Kafka topics"
            echo ""
            
            echo "=========================================="
            echo "END OF DEPLOYMENT LOG"
            echo "=========================================="
            echo "Generated at: $(date)"
            echo "Log file: $LOG_FILE"
            echo ""
          } > "$LOG_FILE" 2>&1
          
          # Xác nhận file đã được tạo
          if [ -f "$LOG_FILE" ]; then
            echo ""
            echo "SUCCESS! Logs saved successfully:"
            echo "   File: $LOG_FILE"
            echo "   Size: $(du -h "$LOG_FILE" | cut -f1)"
            echo "   Path: $(realpath "$LOG_FILE")"
            echo ""
            ls -lh "$LOG_FILE"
            
            # Hiển thị một đoạn ngắn từ log
            echo ""
            echo "Preview (first 50 lines):"
            echo "---"
            head -50 "$LOG_FILE"
            echo "..."
          else
            echo ""
            echo "WARNING: Log file was not created at $LOG_FILE"
            echo "Current directory: $(pwd)"
            echo "Log directory: $LOG_DIR (exists: $([ -d "$LOG_DIR" ] && echo 'Yes' || echo 'No'))"
          fi
          
          echo ""
          echo "=========================================="
          echo "ALL DEPLOYMENT STEPS COMPLETED!"
          echo "=========================================="
          echo "Version: ${{ steps.get_version.outputs.VERSION }}"
          echo "Deployed at: $(date)"
          echo ""
          echo "Active Containers:"
          docker ps --format "  - {{.Names}} ({{.Status}})" | grep -E "(mosquitto|mqtt|kafka|spark|zookeeper)"
          echo ""
          echo "Deployment successful!"
      
      - name: Fix Permissions for Next Run
        if: always()
        run: |
          echo "Fixing file permissions for next deployment..."
          
          # Đặt lại ownership cho các thư mục được tạo bởi containers
          # Điều này đảm bảo lần deploy sau không gặp permission issues
          sudo chown -R $(whoami):$(whoami) gateway/mosquitto 2>/dev/null || true
          sudo chown -R $(whoami):$(whoami) server/spark/checkpoint 2>/dev/null || true
          sudo chown -R $(whoami):$(whoami) server/kafka 2>/dev/null || true
          sudo chown -R $(whoami):$(whoami) server/zookeeper 2>/dev/null || true
          
          echo "Permission fix completed!"

