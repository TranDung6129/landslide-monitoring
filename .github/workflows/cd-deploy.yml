name: Deploy Server Production

on:
  push:
    tags:
      - 'v*' # Chỉ chạy khi đánh tag

# Cấp quyền đọc packages để login vào GHCR
permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # --- BƯỚC MỚI: Đăng nhập để được quyền kéo Image ---
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Server
        run: |
          echo "Bắt đầu deploy phiên bản ${{ steps.get_version.outputs.VERSION }}..."
          
          # 1. Di chuyển vào thư mục server
          cd server
          
          # 2. Thiết lập biến môi trường phiên bản
          export APP_VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # --- BƯỚC MỚI: Tải Image về trước ---
          # Lệnh này đảm bảo tải xong xuôi mới restart, giảm thời gian downtime
          docker compose pull
          
          # 3. Up lại container
          # Dùng 'docker compose' (v2) thay vì 'docker-compose' (v1) nếu server đã cài bản mới
          docker compose up -d --remove-orphans
          
          # 4. RESTART SPARK JOB
          echo "Đang restart Spark Job..."
          
          # Restart container Spark Master
          docker restart spark-master
          
          # Đợi 10s cho Master khởi động xong
          sleep 10
          
          # Submit job mới
          # Lưu ý: Đường dẫn /app/spark_jobs/... phải khớp với volume trong docker-compose
          docker exec -d spark-master /opt/spark/bin/spark-submit \
            --master spark://spark-master:7077 \
            --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0 \
            /app/spark_jobs/processor.py

          echo "Deploy thành công!"